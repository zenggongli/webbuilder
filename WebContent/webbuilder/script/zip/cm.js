var Cm={at:function(){return controlTab.getActiveTab()},editWin:null,clipBoard:null,objectTreeFields:["text","xwlMeta","id","properties","events","custGEditors","custPEditors","custEEditors","custEPara"],setButtons:function(a){appendBtn.setDisabled(a);delBtn.setDisabled(a);copyBtn.setDisabled(a);pasteBtn.setDisabled(a)},findTab:function(b){var a=null;controlTab.items.each(function(d){if(d.bindId==b){a=d;return false}});return a},finalize:function(){Ext.getDoc().on("keydown",Cm.monitorElKey)},createTab:function(g,a,h,e){var b=controlTab;var f,c=Cm.findTab(a);if(c){b.setActiveTab(c);return}function d(m){Wb.decodeValue(m.custGEditors);Wb.decodeValue(m.custPEditors);Wb.decodeValue(m.custEEditors);var j=f.generalGrid;var l=f.propertyGrid;var k=f.eventGrid;j.setSource(m.xwlMeta);j.store.sort("name","ASC");l.setSource(m.properties);l.store.sort("name","ASC");k.setSource(m.events);k.store.sort("name","ASC");j.customEditors=m.custGEditors;l.customEditors=m.custPEditors;k.customEditors=m.custEEditors}function i(k,j,l){var m=l.customEditors[j.record.get("name")];if(m&&m.field){m.field.allowChange=false;if(m.field.blockPost){return false}}return true}b.add({bindId:a,iconCls:h,title:g,closable:true,layout:"fit",xtype:"tabpanel",deferredRender:false,listeners:{render:function(j){f=j},destroy:function(j){if(controlTab.items.length==0){Cm.setButtons(true)}},beforeclose:function(j){if(j.isModified){b.setActiveTab(j);Wb.choose(Wb.format(Str.saveConfirm,j.title.substring(1)),function(k){if(k=="yes"){Cm.saveModule(false,function(){j.close()})}else{if(k=="no"){j.isModified=false;j.close()}}});return false}}},items:[{title:"General",iconCls:"view_icon",xtype:"propertygrid",nameColumnWidth:170,source:{},listeners:{render:function(j){f.generalGrid=j},validateedit:function(k,j){return i(k,j,this)}}},{title:"Properties",iconCls:"property_icon",xtype:"propertygrid",nameColumnWidth:170,source:{},listeners:{render:function(j){f.propertyGrid=j},validateedit:function(k,j){return i(k,j,this)}}},{title:"Events",iconCls:"execute_icon",xtype:"propertygrid",nameColumnWidth:170,source:{},listeners:{render:function(j){f.eventGrid=j},validateedit:function(k,j){return i(k,j,this)}}}]});b.setActiveTab(f);Cm.setButtons(false);if(e){d(Ext.decode(e))}else{Wb.request({url:"main?xwl=13L88K98GZO6&id="+a,mask:f,failure:function(j){f.close()},success:function(j){d(Ext.decode(j.responseText))}})}},saveModule:function(c,f){var d=false,b={},a=Cm.at(),e=Wb.get("controlTab");e.items.each(function(g){if(g.isModified&&(c||g==a)){var h={};d=true;h.xwlMeta=g.generalGrid.source;h.properties=g.propertyGrid.source;h.events=g.eventGrid.source;b["xwl_"+g.bindId]=Ext.encode(h)}});if(d){Wb.request({url:"main?xwl=13L88K98GZO7",params:b,mask:e,success:function(g){e.items.each(function(h){if(h.isModified&&(c||h==a)){Wb.delModified(h)}if(f){f()}})}})}},getKey:function(a,c){for(var b in a){if(a[b].field&&a[b].field.id==c){return b}}return null},monitorKey:function(d,b){if(b.ctrlKey){if(controlTab.items.length==0){return}var a=b.getKey(),f=String.fromCharCode(a);if((f=="C"||f=="V")&&Wb.isEditor(b.getTarget())){return}switch(f){case"C":b.stopEvent();Cm.copyProperties();break;case"V":b.stopEvent();Cm.pasteProperties();break;case"S":b.stopEvent();if(b.shiftKey){Cm.saveModule(true)}else{Cm.saveModule(false)}break;case"N":b.stopEvent();Cm.insertControl(controlTree);break;case"Q":b.stopEvent();Cm.insertProperty();break}}},monitorElKey:function(a,b){Cm.monitorKey(b,a)},monitorChange:function(a){if(a.allowChange&&a.isValid()){Cm.setProperty(a)}},monitorFocus:function(a){a.allowChange=true},populateDblClick:function(a){a.isTriggerField=true;a.inputEl.dom.ondblclick=function(){a.onTriggerClick(a)}},setModified:function(){Wb.setModified(Cm.at())},setProperty:function(f){var e=Cm.at(),d=e.generalGrid;var b=Cm.getKey(d.customEditors,f.id),c=f.getValue();if(c==null||d.source[b]===c){return}d.source[b]=c;Cm.setModified()},getTypeData:function(c){var b=["string","boolean","enum","enumMulti","bind","bindText","bindMulti","text","express","object","date","iconClass","url","urlList","sql","color","jndi","js","ss"];var a=["js","ss","object"];if(c){return a}else{return b}},orgProperty:function(b,a){var d;if(a){d=1}else{d=0}var c="{type:"+Ext.encode(b[d+0]);if(!Ext.isEmpty(b[d+1])){c+=",parameters:"+Ext.encode(b[d+1])}if(!Ext.isEmpty(b[d+2])){c+=",defaultValue: "+Ext.encode(b[d+2])}c+="}";return c},editProperty:function(h){var g;if(h.isTriggerField){g=h}else{g=this}var j=Cm.at(),i=j.propertyGrid,f=j.eventGrid,k;function b(){var l=Cm.getKey(i.customEditors,g.id);if(l){k=false;i.plugins[0].cancelEdit();return l}else{k=true;f.plugins[0].cancelEdit();return Cm.getKey(f.customEditors,g.id)}}function e(n){var o=Cm.orgProperty(n,false);var m=Cm.getKey(i.customEditors,g.id);if(m!=null){i.setProperty(m,o)}else{m=Cm.getKey(f.customEditors,g.id);f.setProperty(m,o)}Cm.setModified()}var a=b(),d=g.getValue(),c;if(Ext.isEmpty(d)){c={type:"string",parameters:"",defaultValue:""};if(k){c.type="js"}}else{c=Ext.decode(d)}Wb.prompt("Edit "+a,[{text:"type",value:c.type,list:Cm.getTypeData(k),allowBlank:false},{text:"parameters",value:Wb.optString(c.parameters)},{text:"defaultValue",value:Wb.optString(c.defaultValue)}],e)},getTree:function(f){var a=controlTree,h=false;var g=a.getRootNode(),d,c,b=1,e=[];g.eachChild(function(i){d=i.get("text");i.eachChild(function(j){e.push({META_TYPE:d,META_NAME:j.get("xwlMeta"),ORDER_INDEX:b});b++});if(f&&d==f.type){e.push({META_TYPE:f.type,META_NAME:f.name,ORDER_INDEX:b});h=true;b++}});if(!h&&f){e.push({META_TYPE:f.type,META_NAME:f.name,ORDER_INDEX:b})}return e},saveControlTree:function(){Wb.request({url:"main?xwl=13L88K98GZO8",mask:controlTree,params:{metaTree:Ext.encode(Cm.getTree())}})},deleteControl:function(a){var a=controlTree,b=a.selectControl;if(!b||b.getDepth()!=2){Wb.warning(Str.selValid);return}Wb.confirm(Wb.format(Str.delConfirm,b.get("text")),function(){var c=b.get("xwlMeta");Wb.request({url:"main?xwl=13L88K98GZOB",mask:a,params:{META_NAME:c},success:function(){Wb.delSelNode(a);var d=Cm.findTab(c);if(d){d.isModified=false;d.close()}}})})},insertControl:function(a){var c,b=a.selectControl;if(b){if(b.getDepth()==2){c=b.parentNode.get("text")}else{c=b.get("text")}}else{c=""}Wb.prompt("New Control",[{text:"Name",value:"",allowBlank:false},{text:"Category",value:c,allowBlank:false}],function(d){var e=a.getRootNode();var f=e.findChild("text",d[1]);Wb.request({url:"main?xwl=13L88K98GZO9",mask:a,params:{META_NAME:d[0],META_TYPE:d[1],metaTree:Ext.encode(Cm.getTree({type:d[1],name:d[0]}))},success:function(g){if(!f){f=e.appendChild({text:d[1]})}var h=f.appendChild({text:d[0],iconCls:"item_icon",xwlMeta:d[0],leaf:true});if(!f.isExpanded()){f.expand()}a.view.select(h);Wb.closePrompt();Cm.createTab(d[0],d[0],"item_icon",g.responseText)}});return false})},eventInitType:"js",propertyInitType:"string",xwlDefine:["xwlClass","xwlType","xwlXtype","xwlText","xwlIconCls","xwlChildren","xwlParent","xwlCategory","xwlWidth","xwlHeight","xwlMinWidth","xwlMaxWidth","xwlMinHeight","xwlMaxHeight"],checkExists:function(a){var b=controlTab.getActiveTab();return Wb.findRecord(b.generalGrid.store,"name",a)||Wb.findRecord(b.propertyGrid.store,"name",a)||Wb.findRecord(b.eventGrid.store,"name",a)},insertProperty:function(){var a=controlTab.getActiveTab();if(!a){return}var b=a.getActiveTab();if(b==a.generalGrid){Wb.prompt("New General Item",[{text:"Name",value:"",list:Cm.xwlDefine,allowBlank:false},{text:"Value",value:""}],function(f){if(Cm.checkExists(f[0])){Wb.warning(Wb.format(Str.alreadyExists,f[0]));return false}b.setProperty(f[0],f[1],true);b.customEditors[f[0]]=new Ext.form.field.Trigger({enableKeyEvents:true,hideTrigger:true,listeners:{keydown:Cm.monitorKey,change:Cm.monitorChange,focus:Cm.monitorFocus}});Cm.setModified()})}else{var e,c=b==a.eventGrid,d;if(c){e="Event";d=Cm.eventInitType}else{e="Property";d=Cm.propertyInitType}Wb.prompt("New "+e,[{text:"name",value:"",allowBlank:false},{text:"type",value:d,list:Cm.getTypeData(c),allowBlank:false},{text:"parameters",value:""},{text:"defaultValue",value:""}],function(f){if(Cm.checkExists(f[0])){Wb.warning(Wb.format(Str.alreadyExists,f[0]));return false}var g=Cm.orgProperty(f,true);b.setProperty(f[0],g,true);b.customEditors[f[0]]=new Ext.form.field.Trigger({enableKeyEvents:true,onTriggerClick:Cm.editProperty,listeners:{keydown:Cm.monitorKey,render:Cm.populateDblClick},editable:false,blockPost:true,triggerCls:"ellipsis_icon"});if(c){Cm.eventInitType=f[1]}else{Cm.propertyInitType=f[1]}Cm.setModified()})}},copyProperties:function(){var a=Cm.at().getActiveTab();Cm.clipBoard=Ext.clone(a.source)},pasteProperties:function(){if(Cm.clipBoard==null){return}var a=false,f,c=Cm.at().getActiveTab(),e=Cm.clipBoard;for(f in e){if(Cm.checkExists(f)){continue}a=true;if(!Ext.isDefined(c.source.n)){if(c==Cm.at().generalGrid){c.customEditors[f]=new Ext.form.field.Trigger({enableKeyEvents:true,hideTrigger:true,listeners:{keydown:Cm.monitorKey,change:Cm.monitorChange,focus:Cm.monitorFocus}})}else{c.customEditors[f]=new Ext.form.field.Trigger({enableKeyEvents:true,onTriggerClick:Cm.editProperty,listeners:{keydown:Cm.monitorKey,render:Cm.populateDblClick},editable:false,blockPost:true,triggerCls:"ellipsis_icon"})}}c.setProperty(f,e[f],true)}if(a){Cm.setModified()}},deleteProperty:function(){var a=Cm.at(),b=a.getActiveTab(),c=b.getSelectionModel().getCurrentPosition();if(c){b.removeProperty(b.store.getAt(c.row).get("name"));Cm.setModified()}}};